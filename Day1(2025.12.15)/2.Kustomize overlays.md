# Chapter 1. Declarative Resource Management

## 1-2. Kustomize Overlays

Kustomize는 Kubernetes 표준 도구로,  
base/overlay 구조와 configMapGenerator, secretGenerator를 사용해  
개발, 스테이징, 테스트, 운영 등의 다양한 환경별 설정을 선언적으로 관리하고 배포한다.

### Kustomize 파일 구조

```code
k8s/
 ├─ base/
 │   ├─ configmap.yaml
 │   ├─ deployment.yaml
 │   ├─ secret.yaml
 │   ├─ service.yaml
 │   ├─ route.yaml 
 │   └─ kustomization.yaml
 └─ overlays/
     ├─ dev/
     │   └─ kustomization.yaml
     ├─ staging/
     │   └─ kustomization.yaml
     └─ prod/
         ├─ kustomization.yaml
         └─ patch.yaml
```
•	base : 공통 리소스  
•	overlays : replica 수, image tag, resource limit, env 등만 수정  

base 와 overlay로 구성되어있고,  
base 하위의 kustomization.yaml에는 모든 리소스가 공유하는 리소스 필드 목록이 있다.

#### base

```bash
# base/kustomization.yaml 예시

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
# 공통으로 사용할 리소스들
resources:
  - configmap.yaml
  - deployment.yaml
  - secret.yaml
  - service.yaml
  - route.yaml
```
#### overlays

base를 수정하지 않고, **namespace, labels, name, replica** 수 등 환경별 차이만 patches로 덮어써서 배포하는 구조  
dev, test, prod 환경별로 파일을 복사하지 않고 설정을 override하며, 여러 overlay가 base 를 공유한다

#### 시험에 자주 나오는 overlay 에서 많이 수정되는 필드

| 필드 | 의미 |
| :--- | :--- |
| `namespace` | 모든 리소스에 namespace 적용 |
| `namePrefix` / `nameSuffix` | 리소스 이름 일괄 변경 |
| `commonLabels` | 모든 리소스 + selector에 라벨 추가 |
| `commonAnnotations` | 모든 리소스에 annotation 추가 |
| `patches` | 특정 리소스만 수정 |

#### patches 메커니즘

```bash
# Kustomization.yaml 

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: prod-env
## patches = 어디에(target)+ 무엇을(patch)
patches:
- path: patch.yaml
  target:
    kind: Deployment
    name: frontend
  options:
    allowNameChange: true
resources:
- ../../base
commonLabels:
env: prod
```

Kustomize v5 이후로 patchesStrategicMerge, patchesJson6902 가 사라지고, patches로 통합되었음.

#### patch의 작성방식 2가지

1) 인라인 Json patch  

```yaml
patch:
- op: replace
  path: /spec/replicas
  value: 15
```

2) 외부 patch 파일 사용  

```yaml
patches:
- path: patch.yaml
  target:
    kind: Deployment
    name: frontend
  options:  ## patch로 리소스 이름(metadata.name)을 바꾸려면 반드시 필요하다
    allowNameChange: true
```

#### 운영, 배포, 테스트 환경 구분 방법

CommonLabel 설정하면,  

- selector에도 반영됨
- 운영/삭제/모니터링/정책 적용가능

```bash
commonLabels:
  env: prod
```


### Kustomize 를 사용해서 리소스 보기 및 배포,삭제

1. Kustomize 사용해서 YAML 생성

```code
kubectl kustomize overlay/production
```
이 명령은:  
	1)	overlay/production/kustomization.yaml 을 읽고  
	2)	거기에 지정된 resources, bases, patches 등을 모두 적용해서  
	3)	최종 Kubernetes YAML을 생성  
	4)	그 결과를 터미널에 출력  
	5)	Kubernetes 클러스터에는 아무 요청도 안 보냄  

즉, 순수 YAML 생성기

2. 해당 YAML을 클러스터 리소스에 적용

```code
kubectl apply -k overlay/production
``` 

3. kustomize 으로 리소스 삭제

```code
oc delete -k overlay/production
```

### Kustomize generator

YAML을 직접 쓰지 않아도 Kustomize를 활용해서  
ConfigMap / Secret을 자동으로 만들기 가능

•  configMapGenerator  
•  secretGenerator


#### ConfigMapGenerator
•  Secret이 아닌 설정값 생성
•  예: 환경변수, 설정 파일, feature flag

#### SecretGenerator
•  민감한 정보
•  예: DB 비밀번호, API 키
•  base64 인코딩 필요 (Kustomize가 자동 처리 가능)


하지만, Kustomize 를 활용하면 아래와 같은 문제가 있다.

•  값 바꿔도 Deployment는 재시작 안 됨
•  Pod가 설정 변경을 모를 수 있음
•  롤링 업데이트 수동 처리 필요



### project 생성하고 Kustomize 활용해서 해당 프로젝트에 앱 만든 후, 로그 모니터링

#### 프로젝트 생성

```code
oc new-project 프로젝트 명
```

#### 프로젝트 내부에 기본 설정으로 앱 배포

```code
oc apply -k 설정디렉토리 명
```

#### 배포된 앱 모니터링

```code
watch oc get all
```

#### watch로 확인 가능한 로그

1) 전체 출력 예시

```bash
NAME                           READY   STATUS    RESTARTS   AGE
pod/my-app-7d8f9c5b6d-abc12    1/1     Running   0          5m
pod/my-app-7d8f9c5b6d-xyz34    1/1     Running   0          5m

NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/my-app   2/2     2            2           10m
                         ^^^     
                        여기가 복제본 수!

NAME                                DESIRED   CURRENT   READY   AGE
replicaset.apps/my-app-7d8f9c5b6d   2         2         2       10m
                                    ^^^
                                    여기도 복제본 수!
```

2) Deployment 로그

```bash
deployment.apps/my-app   2/2     2            2           10m
                         │││
                         ││└─ AVAILABLE (사용 가능한 복제본)
                         │└── UP-TO-DATE (최신 버전 복제본)
                         └─── READY (준비된/원하는 복제본)
                              2/2 = 2개 원함 / 2개 준비됨
```


3) Replicaset 로그

```bash
replicaset.apps/my-app-7d8f9c5b6d   2         2         2       10m
                                    │         │         │
                                    │         │         └─ READY
                                    │         └─────────── CURRENT
                                    └─────────────────── DESIRED (원하는 수)
```

##### 참고 : yaml 파일 문법
key 값은 camelCaseStyle로 작성해주어야 한다.


##### 참고 : 환경설정 추출할 때
이미 만들어져있는 secret값을 추출할때는
oc oc extract secret/db-secrets-55cbgc8c6m --to=-
와 같이 "/"를 사용한다.  
또, "--to=-" 와 같이 설정하면 모니터 창에서만 보인다.