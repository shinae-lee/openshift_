# Chapter2. Deploy Packaged Application

## 2-1. OpenShift Templates

OpenShift Template는 Kubernetes 기본에는 없고 OpenShift에만 제공되는 기능으로,  
Deployment, Service, Route, PVC, ConfigMap, Secret 등 애플리케이션 배포에 필요한  
여러 리소스를 하나의 템플릿으로 묶어 관리한다.  
사용자는 oc new-app --template 명령으로 이 패키지를 한 번에 배포할 수 있다.  

### template parameter

- Deployment : 애플리케이션의 컨테이너와 복제본 수 정의
- Service : 클러스터 내부에서의 서비스 접근 방식 정의
- Route(OpenShift) : 외부로의 접근 경로(URL) 정의
- PersistentVolumeClaim(PVC) : 영구 저장소 요청
- ConfigMap /Secret : 환경 설정 및 비밀 정보

템플릿은 이 모든 개별 리소스를 하나의 논리적인 '패키지'로 다룬다. 
사용자는 단 하나의 명령어 (oc new-app --template=...)만 실행하여 이 전체 패키지를 한 번에 배포할 수 있다.

#### 참고: OpenShift CLI는 단/복수를 구분하지 않는다.

| 축약형 | 복수형 or 단수형 |
| :-- | :-- |
| oc get po | oc get pods or pod |
| oc get svc | oc get services or service |
| oc get deploy | oc get deployments or deployment |
| oc get cm | oc get configmaps or configmap |
| oc get pvc | oc get persistentvolumeclaims or persistentvolumeclaim |

명령어를 사용하거나 설정 파일을 작성할 때, 리소스 이름이 단수건 복수건 상관없이 시스템이 모두 인식한다.

### oc process 

template에는 다양한 parameter가 있고 이를 주입할 때, oc process 명령어를 사용한다.

```bash
oc process mysql-template \
  -p DB_NAME=prod-db \
  -p DB_PASSWORD=mySecurePassword \
  -p CPU_LIMIT=200m \
  | oc apply -f -
```

### template 생성하고, 앱 배포하는법

1) 템플릿 정의 YAML 파일(template-def.yaml)을 직접 작성

2) 작성된 템플릿 정의 파일을 클러스터에 Template 리소스로 등록
네임 스페이스를 지정하지 않았다면, 현재 사용자가 접속해 있는 활성 프로젝트 (Active Project)에 등록됨.

```code
oc apply -f template-def.yaml
```

3) 템플릿 목록 검색
oc get templates -n 네임스페이스이름

4) 다른 네임스페이스에 있는 템플릿이라면 확인해서 로컬에다가 저장
oc get template 사용하려는 템플릿 -n 네임스페이스 -o yaml > 이름.yaml

5) 사용하려는 템플릿의 파라미터 확인
```code
oc process --parameters 템플릿이름 -n 네임스페이스
또는 oc process --parameters -f 이름.yaml
```

6) 프로젝트가 없다면, oc new-project 프로젝트이름 으로 생성하고  
있다면 프로젝트 내부에서 계속진행.

7) 템플릿 활용해서 앱 배포
```bash
# 현재 프로젝트에 cache-service 앱 배포 (기본)
oc new-app --template=cache-service -p APPLICATION_USER=my-user

# 특정 네임스페이스에 배포하려면 -n 옵션 필요
oc new-app --template=cache-service -p APPLICATION_USER=my-user -n other-project
```
new-app명령어는 따로 네임스페이스를 지정하지 않으면 현재 프로젝트(네임스페이스)에 앱을 배포한다.  
특정 네임스페이스에 배포하고 싶으면, -n 옵션을 사용하면 되지만 그것보다는 해당 project 로 이동해서 배포하는 것이 좋다.

```bash
# 현재 프로젝트 확인
oc project

# 다른 프로젝트로 이동
oc project other-project
```

템플릿에 정의된 리소스 타입(Deployment, StatefulSet 등)에 따라 생성되며,  
상태를 가진 서비스(예: redis, memcached ...)는 StatefulSet으로 생성된다.


#### -p : 파라미터 값 직접 설정할 때 씀.

8) 앱 만들고 아래 명령어로 배포 상태 확인
```code
oc get po
```
배포 성공시 NAME 컬럼에 cache-service-0이라는 새로운 service가 하나 생긴다. 

### template으로 앱 만들고 오류 확인하는 법
```code
1) oc logs cache-service-0
2) 위 명령어로도 모르겠을 때, oc describe pod cache-service 
```

### 같은 템플릿으로 배포된 앱 한번에 삭제

1. 앱 배포 전부터 템플릿에 공통적으로 라벨 부여
```yaml
labels:
  template: cache-service
```

2. 같은 라벨을 가진 앱 삭제
```code
oc delete all -l template=템플릿이름
```
하지만 위와 같이 삭제하면,  
Pod, Service, Deployment, DeploymentConfig, ReplicaSet, ReplicationController, Route(OpenShift only) 만 삭제되고
**ConfigMap,Secret,PVC** 는 남아있을 수 있다.

그래서 아래와 같이 삭제 해야 완전히 삭제할 수 있다.

```code
oc delete deployment,svc,route,configmap,secret,pvc -l template=cache-service
```

### 템플릿 삭제

```code
oc get template 템플릿이름 -o yaml | oc delete -f -  
또는, oc delete template 템플릿 이름
```
하지만, Template를 삭제해도, 그 Template로 생성된 리소스들은 삭제되지 않는다.