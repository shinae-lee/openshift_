# Package application 배포

k8s에는 없고 openshift에만 있는 기능
template에 앱 배포에 필요한 요소를 모두 포함해서 배포한다.

포함되는 요소:
- Deployment : 애플리케이션의 컨테이너와 복제본 수 정의
- Service : 클러스터 내부에서의 서비스 접근 방식 정의
- Route(OpenShift) : 외부로의 접근 경로(URL) 정의
- PersistentVolumeClaim(PVC) : 영구 저장소 요청
- ConfigMap /Secret : 환경 설정 및 비밀 정보

템플릿은 이 모든 개별 리소스를 하나의 논리적인 '패키지'로 다룬다. 
사용자는 단 하나의 명령어 (oc new-app --template=...)만 실행하여 이 전체 패키지를 한 번에 배포할 수 있다.

#### 참고: openshif cli는 단/복수를 따지지 않는다.

개발자나 운영자가 명령어를 사용하거나 설정 파일을 작성할 때 리소스 이름을 단수형으로 써도 되고, 복수형으로 써도 시스템이 모두 인식한다


#### oc process 
template에는 다양한 parameter가 있고 이를 주입하는 것이 중요하다.
그럴 때 쓰는 명령어.

```bash
oc process mysql-template \
  -p DB_NAME=prod-db \
  -p DB_PASSWORD=mySecurePassword \
  -p CPU_LIMIT=200m \
  | oc apply -f -
```

### template 만들고 사용해서 앱 배포하는법

1) 템플릿 정의 YAML 파일(template-def.yaml)을 직접 작성


2) 작성된 템플릿 정의 파일을 클러스터에 Template 리소스로 등록
네임 스페이스를 지정하지 않았다면, 현재 사용자가 접속해 있는 활성 프로젝트 (Active Project)에 등록됨.

oc apply -f template-def.yaml



3) 템플릿 목록 검색
oc get templates -n 네임스페이스이름



4) 다른 네임스페이스에 있는 템플릿이라면 확인해서 로컬에다가 저장
oc get template 사용하려는 템플릿 -n 네임스페이스 -o yaml > 이름.yaml



5) 사용하려는 템플릿의 파라미터 확인

oc process --parameters 템플릿이름 -n 네임스페이스
또는 oc process --parameters -f 이름.yaml



6) 프로젝트가 없다면, 
oc new-project 프로젝트이름 으로 생성하고, 
있다면 프로젝트 내부에서 계속진행.



7) 템플릿 활용해서 앱 배포
oc new-app --template=cache-service -p APPLICATION_USER=my-user

new-app은 cluster말고 자동으로 openshift로 namespace를 찾아서 앱을 statefulset.apps의 pod로 만들어준다.

-p : 설정 파일 안에 parameter값이 뒤에 적어준 파라미터값으로 바뀜. 즉, 파라미터 값 직접 설정할 때 씀.



8) 앱 만들고 상태 알고싶으면,
oc get po 쳐보면, 
NAME : cache-service-0이라는 service가 하나 생긴다. 



### template으로 앱 만들고 오류 확인하는 법

1) oc logs cache-service-0
2) 위 명령어로도 모르겠을 때, oc describe pod cache-service 



### 템플릿 활용해서 배포된 statefulset.apps 앱 한꺼번에 삭제

oc delete all -l template=템플릿이름

한번에 삭제하려면 같은 라벨 가진 것들을 삭제해야함.
oc delete all -l template=cache-service


### 템플릿 삭제
oc get template 템플릿이름 -o yaml | oc delete -f -
또는, oc delete template 템플릿 이름