# Chapter3. Authentication and Authorization 

## 3-1. Configure Identity Providers

### HTPasswd ID 프로바이더
외부 시스템(LDAP, GitHub 등) 없이 OpenShift 자체적으로 사용자 ID와 비밀번호를 관리하기 위해서
OpenShift 클러스터에 HTPasswd 방식의 인증 공급자를 설정하여, 관리자가 직접 생성한 사용자 계정으로 로그인가능

HTPasswd를 설정하고 사용자를 관리하려면 먼저 클러스터 관리자 권한으로 로그인해야 함.

### OpenShift 새로 설치될 때 클러스터 관리자 권한 로그인 방법을 2가지

1. X.509 클라이언트 인증서 (kubeconfig 파일 사용):

    설치 시 생성된 kubeconfig 파일(만료되지 않는 인증서 포함)을 사용하여 oc 명령어를 실행  
    export KUBECONFIG=/path/to/kubeconfig 또는 --kubeconfig 옵션을 사용  

2. kubeadmin 가상 사용자 사용:

    설치 시 생성되는 임시 관리자 계정  
    설치 로그에 제공된 비밀번호로 oc login -u kubeadmin -p [비밀번호]를 사용하여 인증

### HTPasswd ID 프로바이더 구성

X.509 클라이언트 인증서 또는 kubeadmin 가상사용자를 활용해서 클러스터 관리자 권한을 확보한 후, HTPasswd를 구성한다.


1. htpasswd 파일 생성/수정

    htpasswd 로컬파일에 cluster 새 사용자 계정 자격 증명 저장(사용자 추가)

    ```code
    htpasswd -c -B -b /tmp/htpasswd student redhat123
    ```

    | 옵션 | 전체 설명 | 간결 역할 | 중요 참고 |
    | :--- | :--- | :--- | :--- |
    | **-c** | Create | **새 파일 생성** | **주의:** 기존 파일 내용을 **모두 삭제**하고 덮어씁니다. 파일을 처음 만들 때만 사용해야 합니다. |
    | **-B** | Bcrypt | **Bcrypt 암호화 방식 사용** | **권장:** 높은 보안 강도로, 최신 환경에서 사용됩니다. |
    | **-b** | Batch | **비밀번호를 명령줄에서 직접 입력** | 비밀번호를 대화형 프롬프트 없이 한 줄로 처리하여 편리합니다. |



2. HTPasswd 시크릿 만들기

    사용자 자격 증명을 저장한 로컬파일(htpasswd)을 openshift 클러스터 내부에 저장하기위해,  
    openshift-config 네임스페이스에 sercet생성

    ```code
    oc create secret generic htpasswd-secret --from-file htpasswd=/tmp/htpasswd -n openshift-config
    ```
    #### 주의할 점 : secret은 꼭 openshift-config namespace 내부에 만들어져야한다!


### OAuth 사용자 지정 리소스 구성

openshift에서는 OAuth 사용자 지정 리소스를 편집해서 어떤 ID 프로바이더를 사용할지 결정할 수 있다.

1. OAuth 사용자 지정 리소스 업데이트

    #### oc get 명령을 사용하여 기존 OAuth 클러스터 리소스를 YAML 형식의 파일로 내보낸다.

    ```code
    oc get oauth cluster -o yaml > oauth.yaml
    ```

    #### 텍스트 편집기에서 결과 파일을 열고 포함된 ID 프로바이더 설정을 필요한 대로 변경
    .spec.identityProviders 배열에 htpasswd 설정 추가.

    ```bash
    apiVersion: config.openshift.io/v1
    kind: OAuth
    metadata:
    name: cluster
    # (중략: 다른 메타데이터 및 spec 내용)
    spec:
    identityProviders:
        # --- 이 부분이 새로 추가되거나 수정되어야 합니다 ---
        - name: my_htpasswd_provider 
        mappingMethod: claim 
        type: HTPasswd
        htpasswd:
            fileData:
            name: htpasswd-secret 
        # ----------------------------------------------------
        # (기존에 다른 ID Provider가 있었다면 그 아래에 유지됩니다.)
    ```

    #### 수정을 완료하고 파일을 저장한 후에는 oc replace 명령을 사용하여 새 사용자 지정 리소스를 적용
    ```code
    oc replace -f oauth.yaml
    ```

    ##### 위의 두 단계(vi oauth.yaml 편집 + oc replace명령) 를 한번에 실행할 수 있는 명렁어는 아래와같음.


    ```code
    oc edit oauth cluster
    ```

    #### OpenShift에서 OAuth 설정을 변경 적용을 위해 수동 재시작
    oc rollout restart -n openshift-authention deployment(oauth server가 설치된 pod가 삭제되고 새로 실행됨..)

